name: CI/CD Pipeline
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened, ready_for_review]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # Job 1: Linting and Code Quality
  lint-and-format:
    name: Code Quality & Linting
    runs-on: ubuntu-22.04
    if: github.event.pull_request.draft == false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-lint-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-lint-
          ${{ runner.os }}-pip-

    - name: Install linting dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort pylint mypy bandit safety

    - name: Run Black (Python formatter)
      run: |
        black --check --diff --color backend/ ml/ qiling_analysis/ analysis/ dynamic_analysis/ ghidra_scripts/ protocol_analysis/ || {
          echo "::error::Code formatting issues found. Run 'black backend/ ml/ qiling_analysis/ analysis/ dynamic_analysis/ ghidra_scripts/ protocol_analysis/' locally to fix."
          exit 1
        }

    - name: Run isort (Import sorting)
      run: |
        isort --check-only --diff --color backend/ ml/ qiling_analysis/ analysis/ dynamic_analysis/ ghidra_scripts/ protocol_analysis/ || {
          echo "::error::Import sorting issues found. Run 'isort backend/ ml/ qiling_analysis/ analysis/ dynamic_analysis/ ghidra_scripts/ protocol_analysis/' locally to fix."
          exit 1
        }

    - name: Run flake8 (Style guide enforcement)
      run: |
        flake8 --max-line-length=100 --extend-ignore=E203,W503,E501 backend/ ml/ qiling_analysis/ analysis/ dynamic_analysis/ ghidra_scripts/ protocol_analysis/

    - name: Run bandit (Security linting)
      run: |
        bandit -r backend/ ml/ qiling_analysis/ analysis/ dynamic_analysis/ ghidra_scripts/ protocol_analysis/ -f json -o bandit-report.json || true
        bandit -r backend/ ml/ qiling_analysis/ analysis/ dynamic_analysis/ ghidra_scripts/ protocol_analysis/

    - name: Upload bandit report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: bandit-security-report
        path: bandit-report.json

  # Job 2: Dependency Security Scan
  security-scan:
    name: Security & Dependency Scan
    runs-on: ubuntu-22.04
    if: github.event.pull_request.draft == false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install safety
      run: pip install safety

    - name: Run safety check
      run: |
        pip install -r requirements.txt -r backend/requirements.txt
        safety check --json --output safety-report.json || true
        safety check

    - name: Upload safety report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: safety-dependency-report
        path: safety-report.json

  # Job 3: Backend Tests
  backend-tests:
    name: Backend Tests & Build
    runs-on: ubuntu-22.04
    if: github.event.pull_request.draft == false
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: testpassword
          POSTGRES_USER: testuser
          POSTGRES_DB: vestigo_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          build-essential \
          libffi-dev \
          libssl-dev \
          libmagic-dev \
          binutils \
          file

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install pytest pytest-cov pytest-asyncio httpx
        pip install -r backend/requirements.txt
        pip install -r requirements.txt

    - name: Set up test environment
      run: |
        echo "DATABASE_URL=postgresql://testuser:testpassword@localhost:5432/vestigo_test" >> $GITHUB_ENV
        echo "OPENAI_API_KEY=test_key_for_ci" >> $GITHUB_ENV

    - name: Run Prisma generate
      working-directory: backend
      run: |
        prisma generate || echo "Prisma generation skipped - schema may need updates"

    - name: Run backend tests
      working-directory: backend
      run: |
        # Check if tests directory exists, if not create a basic test
        if [ ! -d "tests" ] && [ ! -f "test_*.py" ]; then
          echo "No tests found, creating basic import test"
          cat > test_basic.py << 'EOF'
        import pytest
        import sys
        import os
        
        def test_imports():
            """Test basic imports work"""
            try:
                import main
                assert True
            except ImportError as e:
                pytest.skip(f"Import test skipped: {e}")
        
        def test_python_version():
            """Test Python version is compatible"""
            assert sys.version_info >= (3, 9)
        EOF
        fi
        
        # Run tests with coverage if pytest is available
        python -m pytest -v --tb=short --cov=. --cov-report=xml --cov-report=term-missing || {
          echo "Pytest failed or not configured properly"
          echo "Running basic syntax check instead"
          python -m py_compile main.py
        }

    - name: Upload test coverage
      uses: codecov/codecov-action@v3
      if: always()
      with:
        file: ./backend/coverage.xml
        flags: backend
        name: backend-coverage

  # Job 4: Frontend Tests & Build
  frontend-tests:
    name: Frontend Tests & Build
    runs-on: ubuntu-22.04
    if: github.event.pull_request.draft == false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Check if frontend exists
      id: check-frontend
      run: |
        if [ -f "frontend/package.json" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Install frontend dependencies
      if: steps.check-frontend.outputs.exists == 'true'
      working-directory: frontend
      run: |
        # Check if using bun or npm
        if [ -f "bun.lockb" ]; then
          curl -fsSL https://bun.sh/install | bash
          export PATH="$HOME/.bun/bin:$PATH"
          bun install
        else
          npm ci
        fi

    - name: Run frontend linting
      if: steps.check-frontend.outputs.exists == 'true'
      working-directory: frontend
      run: |
        if [ -f "bun.lockb" ]; then
          export PATH="$HOME/.bun/bin:$PATH"
          bun run lint || echo "Frontend linting not configured"
        else
          npm run lint || echo "Frontend linting not configured"
        fi

    - name: Run frontend tests
      if: steps.check-frontend.outputs.exists == 'true'
      working-directory: frontend
      run: |
        if [ -f "bun.lockb" ]; then
          export PATH="$HOME/.bun/bin:$PATH"
          bun run test || echo "Frontend tests not configured"
        else
          npm run test || echo "Frontend tests not configured"
        fi

    - name: Build frontend
      if: steps.check-frontend.outputs.exists == 'true'
      working-directory: frontend
      run: |
        if [ -f "bun.lockb" ]; then
          export PATH="$HOME/.bun/bin:$PATH"
          bun run build || echo "Frontend build not configured"
        else
          npm run build || echo "Frontend build not configured"
        fi

  # Job 5: ML/Analysis Tests
  ml-analysis-tests:
    name: ML & Analysis Tests
    runs-on: ubuntu-22.04
    if: github.event.pull_request.draft == false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-ml-${{ hashFiles('**/requirements*.txt', 'ml/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-ml-
          ${{ runner.os }}-pip-

    - name: Install system dependencies for ML
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          build-essential \
          libffi-dev \
          libssl-dev \
          libmagic-dev

    - name: Install ML dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install pytest numpy pandas scikit-learn
        # Install PyTorch CPU version for CI
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
        pip install -r requirements.txt
        # Install ML-specific requirements if they exist
        [ -f ml/requirements_gnn.txt ] && pip install -r ml/requirements_gnn.txt || true

    - name: Run ML module tests
      run: |
        cd ml/
        # Basic import and syntax tests
        for py_file in *.py; do
          if [ -f "$py_file" ]; then
            echo "Testing $py_file"
            python -m py_compile "$py_file" || echo "Compilation failed for $py_file"
          fi
        done

    - name: Run analysis module tests
      run: |
        cd analysis/
        for py_file in *.py; do
          if [ -f "$py_file" ]; then
            echo "Testing $py_file"
            python -m py_compile "$py_file" || echo "Compilation failed for $py_file"
          fi
        done

  # Job 6: Docker Build Test
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-22.04
    if: github.event.pull_request.draft == false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: false
        tags: vestigo:ci-test
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          GHIDRA_VERSION=11.2.1
          GHIDRA_DATE=20241105

    - name: Test Docker image
      run: |
        # Run a basic smoke test
        docker run --rm vestigo:ci-test python --version
        docker run --rm vestigo:ci-test pip list | grep fastapi || echo "FastAPI check failed"

  # Job 7: Integration Tests (if main branch)
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-22.04
    needs: [backend-tests, docker-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Compose
      run: |
        # Basic integration test setup could go here
        echo "Integration tests would run here for main branch deployments"

  # Job 9: Dependency Review (for PRs only)
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-22.04
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Dependency Review
      uses: actions/dependency-review-action@v3
      with:
        fail-on-severity: moderate
        allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, GPL-3.0

  # Summary job
  ci-success:
    name: CI Success
    runs-on: ubuntu-22.04
    needs: 
      - lint-and-format
      - security-scan
      - backend-tests
      - frontend-tests
      - ml-analysis-tests
      - docker-build
    if: always() && github.event.pull_request.draft == false

    steps:
    - name: Check all jobs status
      run: |
        echo "Lint and Format: ${{ needs.lint-and-format.result }}"
        echo "Security Scan: ${{ needs.security-scan.result }}"
        echo "Backend Tests: ${{ needs.backend-tests.result }}"
        echo "Frontend Tests: ${{ needs.frontend-tests.result }}"
        echo "ML Analysis Tests: ${{ needs.ml-analysis-tests.result }}"
        echo "Docker Build: ${{ needs.docker-build.result }}"
        
        if [ "${{ needs.lint-and-format.result }}" != "success" ] ||
           [ "${{ needs.security-scan.result }}" != "success" ] ||
           [ "${{ needs.backend-tests.result }}" != "success" ] ||
           [ "${{ needs.ml-analysis-tests.result }}" != "success" ] ||
           [ "${{ needs.docker-build.result }}" != "success" ] ||
          echo "❌ Some CI jobs failed"
          exit 1
        else
          echo "✅ All CI jobs passed successfully"
        fi